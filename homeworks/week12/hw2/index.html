<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TodoList</title>
    <style>
      .done {
        text-decoration: line-through;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
      $(document).ready(() => {
        let todos = JSON.parse(localStorage.getItem('todos')) || [];
        const filterTodoType = [
          { todoClass: 'todo-all', type: 'all' },
          { todoClass: 'todo-done__all', type: 'done' },
          { todoClass: 'todo-undone', type: 'undone' },
          { todoClass: 'todo-delete__completed', type: 'deleteCompleted' },
        ];
        const actionTodoType = [];
        const addInput = $('input[name="add"]');
        const todoList = $('.todo-list');

        const renderTodoList = (e) => {
          let target;
          if (e) {
            target = $(e.target);
          } else {
            target = $('.todo-btns').children('.active');
          }
          const { type } = filterTodoType.find((element) =>
            target.hasClass(element.todoClass)
          );
          let filterTodos = [];
          todoList.empty();
          switch (type) {
            case 'all':
              filterTodos = todos;
              break;
            case 'done':
              filterTodos = todos.filter((element) => element.isDone);
              break;
            case 'undone':
              filterTodos = todos.filter((element) => !element.isDone);
              break;
            case 'deleteCompleted':
              todos = todos.filter((element) => !element.isDone);
              filterTodos = todos;
              break;
            default:
              console.log('error type');
              break;
          }
          $.each(filterTodos, function (index, element) {
            const temp = `
          <li class="list-group-item" data-id="${element.id}">
            <div class="d-flex justify-content-between align-items-baseline">
              <div class="d-flex align-items-baseline">
                <input type="checkbox" class="mr-2 todo-mark" ${
                  element.isDone ? 'checked' : ''
                }/>
                <span class="todo ${element.isDone ? 'done' : ''}">${
              element.todo
            }</span>
              </div>
              <div>
                <button class="btn btn-warning mr-3 todo-edit">編輯</button>
                <button class="btn btn-danger mr-3 todo-delete">刪除</button>
              </div>
            </div>
          </li>`;
            todoList.prepend(temp);
          });
          localStorage.setItem('todos', JSON.stringify(todos));
        };

        const handleFilterTodo = (e) => {
          const target = $(e.target);
          if (!target.hasClass('active')) {
            $('.active').removeClass('active');
            target.addClass('active');
          }
          renderTodoList(e);
        };

        const handleAddTodo = (e) => {
          e.preventDefault();
          if (addInput.val().trim() === '') return;
          let todo = {
            id: new Date().getTime(),
            todo: addInput.val(),
            isDone: false,
          };

          todos.push(todo);
          addInput.val('');
          renderTodoList();
        };

        const handleMarkTodo = (dom) => {
          const todoId = dom.data('id');
          todos = todos.map((element) => {
            if (element.id === todoId) {
              element.isDone = !element.isDone;
            }
            return element;
          });
          renderTodoList();
        };

        const handleEditTodo = (dom) => {
          const todoId = dom.data('id');
          const oldTodo = dom.find('.todo').text();
          const editInput = dom.find('input[name="edit"]');
          const editBtn = dom.find('.todo-edit');
          if (editInput.length === 0) {
            dom
              .find('.todo')
              .after(
                `<input type="text" class="ml-2 form-group" name="edit" value=${oldTodo} />`
              );
            editBtn.text('完成編輯');
          } else {
            const editedTodo = editInput.val();
            dom.find('.todo').text(editedTodo);
            editInput.remove();
            editBtn.text('編輯');
          }
        };

        const handleDeleteTodo = (dom) => {
          const todoId = dom.data('id');
          todos = todos.filter((element) => element.id !== todoId);
          renderTodoList();
        };

        renderTodoList();
        $('.todo-add').submit(handleAddTodo);

        $('.todo-btns').delegate('button', 'click', handleFilterTodo);

        $('.todo-list').delegate('li', 'click', function (e) {
          const li = $(this);
          if ($(e.target).hasClass('todo-edit')) {
            handleEditTodo(li);
            return;
          }
          if ($(e.target).hasClass('todo-delete')) {
            handleDeleteTodo(li);
            return;
          }
          if ($(e.target).hasClass('todo-mark')) {
            handleMarkTodo(li);
            return;
          }
        });
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div class="d-flex justify-content-center mt-5">
        <div class="w-75">
          <form class="p-4 todo-add">
            <div class="form-group row">
              <div class="col-sm-10 d-flex align-items-center">
                <input type="text" class="form-control" name="add" />
              </div>
              <div class="col-sm-2 col-form-label">
                <button type="submit" class="btn btn-primary">新增</button>
              </div>
            </div>
          </form>
          <div class="d-flex justify-content-around mb-3 todo-btns">
            <button class="btn btn-primary todo-all active">全部任務</button>
            <button class="btn btn-success todo-done__all">已完成</button>
            <button class="btn btn-info todo-undone">未完成</button>
            <button class="btn btn-danger todo-delete__completed">
              刪除已完成任務
            </button>
          </div>
          <ul class="list-group list-group-flush todo-list"></ul>
        </div>
      </div>
    </div>
  </body>
</html>
